# NestJS Bootstrap & CI 베이스라인 설계 일지 (N2.0)
> Node.js 백엔드 패턴 훈련의 시작점: NestJS 프로젝트 골격 구성 및 CI/CD 파이프라인 확립

## 1. 문제 정의 & 요구사항

### 1.1 목표

이후 N2.1~N2.5 마일스톤을 점진적으로 확장할 수 있는 **견고한 NestJS 프로젝트 기반**을 구축한다:
- TypeScript 기반 NestJS 애플리케이션 부트스트랩
- 환경 설정 및 데이터베이스 연결 (Prisma + SQLite)
- 기본적인 헬스 체크 엔드포인트
- GitHub Actions 기반 CI 파이프라인
- 테스트 자동화 기반 마련

### 1.2 기능 요구사항

#### 1.2.1 NestJS 애플리케이션 구조
1. **프로젝트 초기화**
   - Nest CLI를 이용한 프로젝트 생성
   - TypeScript 설정 (strict mode)
   - 모듈 기반 아키텍처 준비

2. **환경 설정**
   - `@nestjs/config` 모듈 통합
   - `.env`, `.env.local`, `.env.test` 파일 기반 환경 분리
   - 환경 변수:
     - `PORT`: 애플리케이션 포트 (기본: 3000)
     - `NODE_ENV`: 실행 환경 (development/test/production)
     - `DATABASE_URL`: Prisma 데이터베이스 연결 문자열
     - `JWT_SECRET`: JWT 토큰 시크릿 (N2.1에서 사용)
     - `JWT_EXPIRES_IN`: JWT 만료 시간

3. **데이터베이스 설정**
   - Prisma ORM 통합
   - SQLite 사용 (개발/테스트 편의성)
   - PrismaService 모듈 구성
   - 스키마 마이그레이션 준비

4. **헬스 체크 엔드포인트**
   - `GET /api/health`
   - 응답 예시:
     ```json
     {
       "status": "OK",
       "timestamp": "2025-01-30T10:15:30.123Z"
     }
     ```

#### 1.2.2 글로벌 설정
1. **Validation Pipe**
   - `class-validator` + `class-transformer` 통합
   - DTO 자동 검증 및 변환
   - 설정:
     - `whitelist: true` - DTO에 정의되지 않은 속성 제거
     - `forbidNonWhitelisted: true` - 허용되지 않은 속성 시 에러
     - `transform: true` - 타입 자동 변환

2. **Exception Filter**
   - 전역 예외 필터 (`HttpExceptionFilter`)
   - 일관된 에러 응답 포맷
   - 에러 응답 구조:
     ```json
     {
       "statusCode": 400,
       "message": "Validation failed",
       "error": "Bad Request",
       "timestamp": "2025-01-30T10:15:30.123Z",
       "path": "/api/endpoint"
     }
     ```

3. **API Prefix**
   - 모든 엔드포인트에 `/api` 접두사 적용
   - 버전 관리 대비 구조

### 1.3 비기능 요구사항

#### 1.3.1 코드 품질
- TypeScript strict mode 활성화
- ESLint + Prettier 설정
- 일관된 코딩 스타일 유지

#### 1.3.2 테스트
- Jest 테스트 프레임워크
- e2e 테스트 기반 마련
- 최소 1개 이상의 통과하는 테스트

#### 1.3.3 CI/CD
- GitHub Actions 워크플로우 구성
- PR 및 push 시 자동 테스트 실행
- 빌드 검증

---

## 2. 기술적 배경 & 설계 동기

### 2.1 왜 NestJS인가?

**Express의 한계:**
- 구조화되지 않은 자유로운 패턴 → 프로젝트 커질수록 일관성 결여
- DI(Dependency Injection) 부재 → 테스트 어려움, 결합도 증가
- 타입 안정성 부족 (TypeScript 통합 수동 작업 많음)

**NestJS의 강점:**
- **모듈 기반 아키텍처**: 도메인별 캡슐화, 명확한 의존성 관리
- **의존성 주입**: 테스트 용이, 느슨한 결합
- **TypeScript First**: 타입 안정성, IDE 지원 강력
- **데코레이터 기반**: 선언적 코드, 가독성 향상
- **통합 생태계**: Passport(인증), TypeORM/Prisma(ORM), Schedule(배치) 등

### 2.2 왜 Prisma + SQLite인가?

**Prisma 선택 이유:**
- **타입 안정성**: Prisma Client가 스키마 기반 타입 자동 생성
- **마이그레이션**: 스키마 변경 추적 및 버전 관리
- **직관적 API**: `findMany`, `create`, `update` 등 간결한 쿼리
- **트랜잭션 지원**: `$transaction` API로 ACID 보장

**SQLite 사용 (개발/테스트 단계):**
- 설치 불필요 (파일 기반 DB)
- CI 환경에서 in-memory 모드 (`file::memory:`) 사용 가능
- 빠른 테스트 실행
- 프로덕션은 PostgreSQL로 전환 가능 (provider만 변경)

**트레이드오프:**
- SQLite는 enum, array 타입 미지원 → String + 주석으로 우회
- 동시성 제약 → 프로덕션 환경에서는 PostgreSQL 권장

### 2.3 CI/CD 초기 구축의 중요성

**N2.0에서 CI를 먼저 만드는 이유:**
- **품질 게이트 확립**: 이후 마일스톤 개발 시 회귀 방지
- **자동화된 검증**: 테스트 통과 여부 즉시 확인
- **협업 기반**: PR 리뷰 시 CI 결과 기준으로 판단
- **점진적 확장**: N2.1~N2.5에서는 테스트만 추가, CI 설정 재작업 불필요

---

## 3. 프로젝트 구조 설계

### 3.1 디렉터리 구조

```text
web-phase1-5-node/
├── .github/
│   └── workflows/
│       └── ci.yml                # GitHub Actions CI 파이프라인
├── prisma/
│   ├── schema.prisma             # 데이터베이스 스키마 정의
│   └── migrations/               # 마이그레이션 히스토리
├── src/
│   ├── common/                   # 공통 모듈
│   │   ├── health/               # 헬스 체크
│   │   │   └── health.controller.ts
│   │   ├── prisma/               # Prisma 서비스
│   │   │   ├── prisma.module.ts
│   │   │   └── prisma.service.ts
│   │   ├── filters/              # 예외 필터
│   │   │   └── http-exception.filter.ts
│   │   └── exceptions/           # 커스텀 예외 (N2.1+)
│   ├── app.module.ts             # 루트 모듈
│   └── main.ts                   # 애플리케이션 진입점
├── test/
│   ├── app.e2e-spec.ts           # 기본 e2e 테스트
│   └── jest-e2e.json             # e2e 테스트 설정
├── .env.example                  # 환경 변수 예시
├── .env.test                     # 테스트 환경 변수
├── .eslintrc.js                  # ESLint 설정
├── .prettierrc                   # Prettier 설정
├── nest-cli.json                 # Nest CLI 설정
├── package.json
├── tsconfig.json                 # TypeScript 설정
└── tsconfig.build.json           # 빌드용 TypeScript 설정
```

### 3.2 모듈 의존성 그래프

```text
AppModule (루트)
  ├─ ConfigModule (글로벌)
  ├─ CacheModule (글로벌, N2.3+)
  ├─ PrismaModule
  └─ HealthController
```

**설계 포인트:**
- `ConfigModule`을 글로벌로 설정 → 모든 모듈에서 환경 변수 접근
- `PrismaModule`도 글로벌 가능 → 각 도메인 모듈에서 `PrismaService` 주입

---

## 4. 핵심 구현 상세

### 4.1 main.ts - 애플리케이션 부트스트랩

```typescript
// src/main.ts
import { NestFactory } from '@nestjs/core';
import { ValidationPipe } from '@nestjs/common';
import { AppModule } from './app.module';
import { HttpExceptionFilter } from './common/filters/http-exception.filter';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  // 전역 예외 필터
  app.useGlobalFilters(new HttpExceptionFilter());

  // 전역 Validation Pipe
  app.useGlobalPipes(
    new ValidationPipe({
      whitelist: true,
      forbidNonWhitelisted: true,
      transform: true,
    }),
  );

  // API 접두사
  app.setGlobalPrefix('api');

  const port = process.env.PORT || 3000;
  await app.listen(port);
  console.log(`Application is running on: http://localhost:${port}`);
}

bootstrap();
```

**설계 결정:**
- `useGlobalFilters`: 모든 예외를 일관되게 처리
- `useGlobalPipes`: DTO 검증 자동화
- `setGlobalPrefix`: API 버전 관리 대비 (`/api/v1` 가능)

### 4.2 AppModule - 루트 모듈

```typescript
// src/app.module.ts
import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { HealthController } from './common/health/health.controller';
import { PrismaModule } from './common/prisma/prisma.module';

@Module({
  imports: [
    ConfigModule.forRoot({
      isGlobal: true,
      envFilePath: ['.env.local', '.env'],
    }),
    PrismaModule,
  ],
  controllers: [HealthController],
})
export class AppModule {}
```

**설계 포인트:**
- `ConfigModule.forRoot`: 환경 변수 로딩, `.env.local` 우선순위 높음
- `isGlobal: true`: 모든 하위 모듈에서 `ConfigService` 주입 가능

### 4.3 PrismaService - 데이터베이스 연결 관리

```typescript
// src/common/prisma/prisma.service.ts
import { Injectable, OnModuleInit, OnModuleDestroy } from '@nestjs/common';
import { PrismaClient } from '@prisma/client';

@Injectable()
export class PrismaService extends PrismaClient implements OnModuleInit, OnModuleDestroy {
  async onModuleInit() {
    await this.$connect();
  }

  async onModuleDestroy() {
    await this.$disconnect();
  }
}
```

**설계 결정:**
- `OnModuleInit`: 모듈 초기화 시 DB 연결
- `OnModuleDestroy`: 애플리케이션 종료 시 연결 정리
- 싱글톤 패턴: NestJS DI 컨테이너가 인스턴스 하나만 유지

### 4.4 HealthController - 헬스 체크

```typescript
// src/common/health/health.controller.ts
import { Controller, Get } from '@nestjs/common';

@Controller('health')
export class HealthController {
  @Get()
  check() {
    return {
      status: 'OK',
      timestamp: new Date().toISOString(),
    };
  }
}
```

**용도:**
- 로드 밸런서 헬스 체크 엔드포인트
- CI/CD 파이프라인 검증
- 배포 후 smoke test

### 4.5 HttpExceptionFilter - 예외 처리

```typescript
// src/common/filters/http-exception.filter.ts
import { ExceptionFilter, Catch, ArgumentsHost, HttpException, HttpStatus } from '@nestjs/common';
import { Request, Response } from 'express';

@Catch()
export class HttpExceptionFilter implements ExceptionFilter {
  catch(exception: unknown, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<Response>();
    const request = ctx.getRequest<Request>();

    const status =
      exception instanceof HttpException
        ? exception.getStatus()
        : HttpStatus.INTERNAL_SERVER_ERROR;

    const message =
      exception instanceof HttpException
        ? exception.getResponse()
        : 'Internal server error';

    response.status(status).json({
      statusCode: status,
      timestamp: new Date().toISOString(),
      path: request.url,
      message,
    });
  }
}
```

**설계 포인트:**
- 모든 예외 캐치 (`@Catch()` 인자 없음)
- 일관된 에러 응답 포맷
- 프로덕션 환경에서는 민감 정보 노출 방지 로직 추가 필요

---

## 5. Prisma 스키마 설계

### 5.1 초기 스키마 (N2.0)

```prisma
// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// N2.1에서 User, Project, Issue, Comment 추가 예정
// N2.2에서 Team, TeamMember, WorkspaceItem 추가 예정
// ...
```

**설계 전략:**
- N2.0에서는 빈 스키마로 시작
- 각 마일스톤마다 도메인 모델 추가
- 마이그레이션 히스토리로 변경 추적

### 5.2 마이그레이션 전략

```bash
# 스키마 변경 후 마이그레이션 생성
npm run prisma:migrate dev --name init

# 클라이언트 코드 재생성
npm run prisma:generate
```

**주의사항:**
- `prisma migrate dev`: 개발 환경 전용
- `prisma migrate deploy`: 프로덕션 배포 시 사용
- CI 환경에서는 `prisma generate`만 실행 (스키마 → 클라이언트 생성)

---

## 6. CI/CD 파이프라인 설계

### 6.1 GitHub Actions 워크플로우

```yaml
# .github/workflows/ci.yml
name: CI

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
  pull_request:
    branches:
      - main
      - develop

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npm run prisma:generate
        env:
          DATABASE_URL: "file::memory:?cache=shared"

      - name: Run unit tests
        run: npm test
        env:
          DATABASE_URL: "file::memory:?cache=shared"

      - name: Run e2e tests
        run: npm run test:e2e
        env:
          DATABASE_URL: "file::memory:?cache=shared"
          NODE_ENV: test

      - name: Build
        run: npm run build
```

### 6.2 CI 단계 설명

| 단계 | 목적 | 실패 시 의미 |
|------|------|--------------|
| Checkout | 코드 체크아웃 | Git 설정 오류 |
| Setup Node.js | Node 20 환경 구성 | 런타임 버전 문제 |
| Install dependencies | `npm ci` 실행 (정확한 버전) | package-lock.json 불일치 |
| Generate Prisma | 스키마 → 클라이언트 코드 생성 | 스키마 문법 오류 |
| Run unit tests | Jest 단위 테스트 | 로직 오류 |
| Run e2e tests | 통합 테스트 | API 계약 깨짐 |
| Build | TypeScript 컴파일 | 타입 오류 |

### 6.3 환경 변수 관리

**CI 환경:**
- `DATABASE_URL`: in-memory SQLite (`file::memory:`)
- `NODE_ENV`: test
- 민감 정보 없음 (JWT_SECRET 불필요, N2.1+에서 필요 시 GitHub Secrets 사용)

**로컬 개발:**
- `.env.local` 파일 사용
- `.env.local`은 `.gitignore`에 포함

---

## 7. 테스트 전략

### 7.1 e2e 테스트 (N2.0)

```typescript
// test/app.e2e-spec.ts
import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication, ValidationPipe } from '@nestjs/common';
import * as request from 'supertest';
import { AppModule } from './../src/app.module';
import { HttpExceptionFilter } from './../src/common/filters/http-exception.filter';

describe('AppController (e2e)', () => {
  let app: INestApplication;

  beforeEach(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();

    app.useGlobalFilters(new HttpExceptionFilter());
    app.useGlobalPipes(
      new ValidationPipe({
        whitelist: true,
        forbidNonWhitelisted: true,
        transform: true,
      }),
    );
    app.setGlobalPrefix('api');

    await app.init();
  });

  afterEach(async () => {
    await app.close();
  });

  it('/api/health (GET)', () => {
    return request(app.getHttpServer())
      .get('/api/health')
      .expect(200)
      .expect((res) => {
        expect(res.body).toHaveProperty('status', 'OK');
        expect(res.body).toHaveProperty('timestamp');
      });
  });
});
```

**설계 포인트:**
- `beforeEach`에서 앱 재생성 → 테스트 격리
- 실제 `main.ts`와 동일한 설정 적용
- `afterEach`에서 정리 → 리소스 누수 방지

### 7.2 테스트 실행 명령어

```bash
# 단위 테스트
npm test

# 단위 테스트 (watch 모드)
npm run test:watch

# e2e 테스트
npm run test:e2e

# 커버리지
npm run test:cov
```

---

## 8. 환경 설정 파일

### 8.1 .env.example

```env
# Application
PORT=3000
NODE_ENV=development

# Database
DATABASE_URL="file:./dev.db"

# JWT (N2.1+)
JWT_SECRET=your-secret-key-change-in-production
JWT_EXPIRES_IN=1d

# Elasticsearch (N2.4+)
ELASTICSEARCH_NODE=http://localhost:9200
ELASTICSEARCH_ENABLED=false

# Kafka (N2.5+)
KAFKA_BROKERS=localhost:9092
KAFKA_CLIENT_ID=web-phase1-5-node
KAFKA_GROUP_ID=notification-consumer-group
KAFKA_ENABLED=false
```

### 8.2 .env.test

```env
NODE_ENV=test
DATABASE_URL="file::memory:?cache=shared"
JWT_SECRET=test-secret
JWT_EXPIRES_IN=1h
ELASTICSEARCH_ENABLED=false
KAFKA_ENABLED=false
```

---

## 9. package.json 스크립트

```json
{
  "scripts": {
    "build": "nest build",
    "start": "nest start",
    "start:dev": "nest start --watch",
    "start:prod": "node dist/main",
    "test": "jest",
    "test:watch": "jest --watch",
    "test:cov": "jest --coverage",
    "test:e2e": "jest --config ./test/jest-e2e.json",
    "prisma:generate": "prisma generate",
    "prisma:migrate": "prisma migrate dev",
    "prisma:studio": "prisma studio",
    "lint": "eslint \"{src,apps,libs,test}/**/*.ts\" --fix",
    "format": "prettier --write \"src/**/*.ts\" \"test/**/*.ts\""
  }
}
```

---

## 10. 검증 체크리스트

### 10.1 로컬 환경 검증

- [ ] `npm install` 성공
- [ ] `npm run prisma:generate` 성공
- [ ] `npm test` 모두 통과
- [ ] `npm run test:e2e` 모두 통과
- [ ] `npm run build` 성공
- [ ] `npm run start:dev` 실행 후 `http://localhost:3000/api/health` 200 응답

### 10.2 CI 환경 검증

- [ ] GitHub에 push 시 CI 워크플로우 자동 실행
- [ ] CI 모든 단계 성공 (초록색 체크)
- [ ] PR 생성 시 CI 상태 확인 가능

### 10.3 코드 품질

- [ ] ESLint 경고 0개
- [ ] Prettier 포맷 적용됨
- [ ] TypeScript strict mode 통과

---

## 11. 다음 마일스톤과의 연결

### N2.0에서 확립된 것

- NestJS 프로젝트 골격
- 환경 설정 체계 (ConfigModule)
- Prisma ORM 통합
- 글로벌 Validation Pipe
- 글로벌 Exception Filter
- CI/CD 파이프라인
- 테스트 자동화 기반

### N2.1에서 추가될 것

- 도메인 모델 (User, Project, Issue, Comment)
- Controller/Service/Repository 패턴
- JWT 인증
- DTO 검증
- 트랜잭션 처리

### N2.2에서 추가될 것

- Team, TeamMember 도메인
- RBAC (Role-Based Access Control)
- Guard를 이용한 인가 처리
- 401/403/404 상태 코드 구분

---

## 12. 알려진 제약 & 향후 개선점

### 12.1 현재 제약

1. **단순한 헬스 체크**
   - DB 연결 상태 확인 없음
   - 개선: `@nestjs/terminus` 모듈로 DB, 외부 API 상태 체크

2. **로깅 부족**
   - 기본 `console.log`만 사용
   - 개선: `pino` 또는 `winston` 통합, 구조화된 로그

3. **환경 변수 검증 없음**
   - 필수 환경 변수 누락 시 런타임 에러
   - 개선: `joi` 스키마로 부트스트랩 시점 검증

4. **테스트 커버리지 미측정**
   - 현재 커버리지 기준 없음
   - 개선: N2.1+에서 커버리지 70% 목표 설정

### 12.2 확장 포인트

- **API 문서화**: Swagger (`@nestjs/swagger`) 추가
- **요청 로깅**: Morgan 미들웨어 또는 커스텀 인터셉터
- **보안 헤더**: Helmet 미들웨어
- **Rate Limiting**: `@nestjs/throttler` (N2.3+)

---

## 13. 완료 기준 (Definition of Done)

### 13.1 필수 조건

✅ NestJS 프로젝트 생성 완료
✅ Prisma 설정 및 PrismaService 구현
✅ ConfigModule 글로벌 설정
✅ ValidationPipe 글로벌 적용
✅ HttpExceptionFilter 구현
✅ `/api/health` 엔드포인트 동작
✅ e2e 테스트 1개 이상 통과
✅ GitHub Actions CI 파이프라인 구축
✅ CI에서 테스트 + 빌드 성공
✅ `.env.example`, `.env.test` 파일 준비
✅ README.md 작성 (설치/실행 가이드)

### 13.2 선택 조건

- [ ] Swagger API 문서 생성
- [ ] 커버리지 리포트 CI 업로드
- [ ] Docker Compose 파일 (PostgreSQL 환경)

---

## 14. 참고 자료

- [NestJS 공식 문서](https://docs.nestjs.com/)
- [Prisma 공식 문서](https://www.prisma.io/docs)
- [GitHub Actions 문서](https://docs.github.com/en/actions)
- [class-validator 문서](https://github.com/typestack/class-validator)
