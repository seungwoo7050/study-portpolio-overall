// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// N2.1 - Issue Tracker Domain Models
model User {
  id           Int       @id @default(autoincrement())
  email        String    @unique
  passwordHash String
  nickname     String
  createdAt    DateTime  @default(now())

  // Relations
  reportedIssues        Issue[]         @relation("ReportedIssues")
  assignedIssues        Issue[]         @relation("AssignedIssues")
  comments              Comment[]
  teamMemberships       TeamMember[]
  createdWorkspaceItems WorkspaceItem[] @relation("CreatedWorkspaceItems")
  orders                Order[]
  notifications         Notification[]
}

model Project {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  createdAt   DateTime @default(now())

  // Relations
  issues Issue[]
}

// Note: SQLite doesn't support enums, so we use String
// Valid values: OPEN, IN_PROGRESS, RESOLVED, CLOSED
model Issue {
  id          Int      @id @default(autoincrement())
  projectId   Int
  reporterId  Int
  assigneeId  Int?
  title       String
  description String?
  status      String   @default("OPEN")
  viewCount   Int      @default(0) // N2.3: For tracking popular issues
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  project  Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  reporter User      @relation("ReportedIssues", fields: [reporterId], references: [id], onDelete: Cascade)
  assignee User?     @relation("AssignedIssues", fields: [assigneeId], references: [id], onDelete: SetNull)
  comments Comment[]

  @@index([projectId])
  @@index([reporterId])
  @@index([assigneeId])
  @@index([status])
}

model Comment {
  id        Int      @id @default(autoincrement())
  issueId   Int
  authorId  Int
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  issue  Issue @relation(fields: [issueId], references: [id], onDelete: Cascade)
  author User  @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([issueId])
  @@index([authorId])
}

// N2.2 - Team & RBAC Domain Models
model Team {
  id        Int      @id @default(autoincrement())
  name      String
  createdAt DateTime @default(now())

  // Relations
  members        TeamMember[]
  workspaceItems WorkspaceItem[]
}

// Valid role values: OWNER, MANAGER, MEMBER
model TeamMember {
  id       Int      @id @default(autoincrement())
  teamId   Int
  userId   Int
  role     String   // OWNER, MANAGER, MEMBER
  joinedAt DateTime @default(now())

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model WorkspaceItem {
  id        Int      @id @default(autoincrement())
  teamId    Int
  title     String
  content   String?
  createdBy Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  team    Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  creator User @relation("CreatedWorkspaceItems", fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([createdBy])
}

// N2.3 - Statistics Domain Models
model DailyIssueStats {
  id             Int      @id @default(autoincrement())
  date           String   @unique // Format: YYYY-MM-DD
  createdCount   Int      @default(0)
  resolvedCount  Int      @default(0)
  commentCount   Int      @default(0)
  createdAt      DateTime @default(now())

  @@index([date])
}

// N2.4 - Product Catalog Domain Models
// Valid status values: ACTIVE, INACTIVE
model Product {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  category    String
  brand       String
  price       Float
  status      String   @default("ACTIVE") // ACTIVE, INACTIVE
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  orderItems OrderItem[]

  @@index([category])
  @@index([brand])
  @@index([status])
  @@index([price])
}

// N2.5 - Order & Notification Domain Models
// Valid status values: PENDING, PAID, CANCELLED
model Order {
  id          Int      @id @default(autoincrement())
  userId      Int
  totalAmount Float
  status      String   @default("PENDING") // PENDING, PAID, CANCELLED
  createdAt   DateTime @default(now())

  // Relations
  user  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  items OrderItem[]

  @@index([userId])
  @@index([status])
}

model OrderItem {
  id        Int   @id @default(autoincrement())
  orderId   Int
  productId Int
  quantity  Int
  price     Float

  // Relations
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([productId])
}

// Valid notification types: ORDER_CREATED, ORDER_PAID, ORDER_CANCELLED
model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  type      String
  message   String
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
}
