# 문서 4. 고급 패턴 (M5-M6: Search/Performance + Testing)

> 이 문서는 **Milestone 5-6 (선택)** 용이다.
> 전제:
>
> * M1-M4 완료 (Bootstrap + CRUD + Auth + React Query)
> * 이제 **검색/성능 최적화**, **테스트/접근성**을 경험할 준비가 된 상태

---

## 0. 전제 / 목표

### 전제

* M1-M4 완료 (React 기초 + 인증 + 상태관리)
* React Query 사용 경험
* 성능 최적화 필요성 이해

### 이 문서의 목표

1. **검색 UI** 구현 (디바운스) (M5)
2. **성능 최적화** (가상 스크롤, 코드 스플리팅)
3. **테스트** 작성 (Vitest + RTL) (M6)
4. **접근성** 개선 (ARIA, 키보드 네비게이션)

---

## 1. M5: 검색/필터 UI + 성능 기초

### 1.1 검색 UI (디바운스)

```bash
npm install lodash-es
npm install --save-dev @types/lodash-es
```

```typescript
// src/features/search/SearchPage.tsx
import { useState, useMemo } from 'react';
import { useQuery } from '@tanstack/react-query';
import { debounce } from 'lodash-es';
import { apiRequest } from '@/shared/lib/apiClient';

export function SearchPage() {
  const [searchTerm, setSearchTerm] = useState('');
  const [debouncedTerm, setDebouncedTerm] = useState('');

  const debouncedSearch = useMemo(
    () =>
      debounce((value: string) => {
        setDebouncedTerm(value);
      }, 500),
    [],
  );

  function handleSearchChange(e: React.ChangeEvent<HTMLInputElement>) {
    const value = e.target.value;
    setSearchTerm(value);
    debouncedSearch(value);
  }

  const { data, isLoading } = useQuery({
    queryKey: ['search', 'products', debouncedTerm],
    queryFn: () =>
      apiRequest(`/search/products?q=${encodeURIComponent(debouncedTerm)}`),
    enabled: debouncedTerm.length > 0,
  });

  return (
    <div>
      <input
        type="text"
        value={searchTerm}
        onChange={handleSearchChange}
        placeholder="검색..."
        className="w-full px-4 py-2 rounded-md border"
      />

      {isLoading && <div>Searching...</div>}

      {data && (
        <div className="mt-4 space-y-2">
          {data.items.map((item: any) => (
            <div key={item.id} className="p-4 bg-white rounded-lg shadow">
              <h3 className="font-semibold">{item.name}</h3>
              <p className="text-sm text-gray-600">{item.description}</p>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}
```

### 1.2 가상 스크롤 (react-window)

```bash
npm install react-window
npm install --save-dev @types/react-window
```

```typescript
// src/features/issue/VirtualizedIssueList.tsx
import { FixedSizeList } from 'react-window';
import { Issue } from './types';

interface VirtualizedIssueListProps {
  issues: Issue[];
}

export function VirtualizedIssueList({ issues }: VirtualizedIssueListProps) {
  function Row({ index, style }: { index: number; style: React.CSSProperties }) {
    const issue = issues[index];

    return (
      <div style={style} className="px-4 py-2 border-b hover:bg-gray-50">
        <h3 className="font-semibold">{issue.title}</h3>
        <p className="text-sm text-gray-600">{issue.description}</p>
      </div>
    );
  }

  return (
    <FixedSizeList
      height={600}
      itemCount={issues.length}
      itemSize={80}
      width="100%"
    >
      {Row}
    </FixedSizeList>
  );
}
```

### 1.3 코드 스플리팅 (React.lazy)

```typescript
// src/App.tsx (수정)
import { lazy, Suspense } from 'react';

const StatsPage = lazy(() => import('./features/stats/StatsPage'));
const SearchPage = lazy(() => import('./features/search/SearchPage'));

export default function App() {
  return (
    <Routes>
      <Route
        path="/stats"
        element={
          <Suspense fallback={<div>Loading...</div>}>
            <StatsPage />
          </Suspense>
        }
      />
      <Route
        path="/search"
        element={
          <Suspense fallback={<div>Loading...</div>}>
            <SearchPage />
          </Suspense>
        }
      />
    </Routes>
  );
}
```

---

## 2. M6: 테스트 전략 & E2E & 접근성

### 2.1 Vitest + React Testing Library

```bash
npm install --save-dev vitest @testing-library/react @testing-library/jest-dom @testing-library/user-event jsdom
```

**vitest.config.ts**:

```typescript
import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  test: {
    environment: 'jsdom',
    globals: true,
    setupFiles: './tests/setup.ts',
  },
});
```

**tests/setup.ts**:

```typescript
import '@testing-library/jest-dom';
```

**Button 컴포넌트 테스트**:

```typescript
// src/shared/components/Button.test.tsx
import { render, screen } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { Button } from './Button';
import { describe, it, expect, vi } from 'vitest';

describe('Button', () => {
  it('renders children correctly', () => {
    render(<Button>Click me</Button>);
    expect(screen.getByText('Click me')).toBeInTheDocument();
  });

  it('calls onClick when clicked', async () => {
    const handleClick = vi.fn();
    render(<Button onClick={handleClick}>Click me</Button>);

    await userEvent.click(screen.getByText('Click me'));
    expect(handleClick).toHaveBeenCalledTimes(1);
  });

  it('applies variant classes correctly', () => {
    const { rerender } = render(<Button variant="primary">Primary</Button>);
    expect(screen.getByText('Primary')).toHaveClass('bg-blue-600');

    rerender(<Button variant="danger">Danger</Button>);
    expect(screen.getByText('Danger')).toHaveClass('bg-red-600');
  });
});
```

### 2.2 E2E 테스트 (Cypress)

```bash
npm install --save-dev cypress
npx cypress open
```

**cypress/e2e/login.cy.ts**:

```typescript
describe('Login Flow', () => {
  it('should login successfully', () => {
    cy.visit('/login');

    cy.get('input[type="email"]').type('user@example.com');
    cy.get('input[type="password"]').type('password123');
    cy.get('button[type="submit"]').click();

    cy.url().should('eq', 'http://localhost:5173/');
    cy.contains('Issue Tracker').should('be.visible');
  });

  it('should show error with invalid credentials', () => {
    cy.visit('/login');

    cy.get('input[type="email"]').type('wrong@example.com');
    cy.get('input[type="password"]').type('wrongpassword');
    cy.get('button[type="submit"]').click();

    cy.contains('로그인에 실패했습니다').should('be.visible');
  });
});
```

### 2.3 접근성 (ARIA)

```typescript
// src/shared/components/Button.tsx (개선)
export function Button({ children, ...props }: ButtonProps) {
  return (
    <button
      {...props}
      aria-label={props['aria-label'] || (typeof children === 'string' ? children : undefined)}
    >
      {children}
    </button>
  );
}
```

**키보드 네비게이션**:

```typescript
// src/features/issue/IssueCard.tsx
export function IssueCard({ issue }: { issue: Issue }) {
  return (
    <div
      role="button"
      tabIndex={0}
      onClick={() => navigate(`/issues/${issue.id}`)}
      onKeyDown={(e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          navigate(`/issues/${issue.id}`);
        }
      }}
      className="p-4 bg-white rounded-lg shadow cursor-pointer hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500"
    >
      <h3 className="font-semibold">{issue.title}</h3>
      <p className="text-sm text-gray-600">{issue.description}</p>
    </div>
  );
}
```

---

## 3. M5-M6 체크리스트

### M5 체크리스트

* [ ] 검색 입력에 디바운스를 적용하고, API 호출 횟수를 줄일 수 있다.
* [ ] react-window로 긴 목록을 가상 스크롤할 수 있다.
* [ ] React.lazy + Suspense로 페이지를 코드 스플리팅할 수 있다.
* [ ] Lighthouse로 성능을 측정하고, 개선점을 파악할 수 있다.

### M6 체크리스트

* [ ] Vitest + React Testing Library로 컴포넌트 단위 테스트를 작성할 수 있다.
* [ ] E2E 테스트로 로그인 → 이슈 생성 플로우를 자동 검증할 수 있다.
* [ ] ARIA 레이블을 추가하고, 스크린 리더로 확인할 수 있다.
* [ ] 키보드만으로 애플리케이션을 사용할 수 있다.
* [ ] axe DevTools로 접근성 문제를 찾고 수정할 수 있다.

---

## 4. 참고 자료

* [React Testing Library](https://testing-library.com/react)
* [Vitest](https://vitest.dev/)
* [Cypress](https://www.cypress.io/)
* [Web Accessibility (MDN)](https://developer.mozilla.org/en-US/docs/Web/Accessibility)
* [ARIA Authoring Practices Guide](https://www.w3.org/WAI/ARIA/apg/)
